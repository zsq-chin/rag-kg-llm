services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: CUPer123456
      MYSQL_DATABASE: test
      MYSQL_USER: app_user
      MYSQL_PASSWORD: app_password
    volumes:
      - ./docker/volumes/mysql/data:/var/lib/mysql
      - ./docker/volumes/mysql/init:/docker-entrypoint-initdb.d  # 初始化脚本目录
    ports:
      - "3307:3306"  # 保持与你原来代码相同的端口
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: docker/api.Dockerfile
      args:
        - DOCKER_BUILDKIT=1
    image: shanhai-api:0.1.0
    container_name: api-dev
    working_dir: /app
    volumes:
      - ./server:/app/server
      - ./src:/app/src
      - ./saves:/app/saves
      - ./test:/app/test
      - ./tianshu/data/output:/app/output:rw
      - ./saves/data/copypath:/app/saves/data/copypath:rw
      - ./indexing:/app/indexing:rw
      - ${MODEL_DIR:-./models}:/models  # 使用默认值处理未定义的环境变量
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
        limits:
          memory: 40g
    ports:
      - "5050:5050"
    networks:
      - app-network
    # 容器内可以通过 host.docker.internal 访问宿主机上的服务
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NEO4J_URI=bolt://graph:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-0123456789}
      - MILVUS_URI=http://milvus:19530
      - MINERU_OCR_URI=http://mineru-api:5051
      - MODEL_DIR=/models
      - RUNNING_IN_DOCKER=true
    depends_on:
      mysql:
        condition: service_healthy
    command: uv run uvicorn server.main:app --host 0.0.0.0 --port 5050 --reload
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: docker/web.Dockerfile
      # 只构建web.Dockerfile中的开发环境
      target: development
    image: shanhai-web:0.1.0
    container_name: web-dev
    volumes:
      - ./web:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - api
    networks:
      - app-network
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://api:5050
    command: pnpm run server
    restart: unless-stopped

  graph:
    image: neo4j:5.26
    container_name: graph
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - ./docker/volumes/neo4j/data:/data
      - ./docker/volumes/neo4j/logs:/var/lib/neo4j/logs
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-0123456789}
      - NEO4J_server_bolt_listen__address=0.0.0.0:7687
      - NEO4J_server_http_listen__address=0.0.0.0:7474
      - ENTITY_EMBEDDING=true
    networks:
      - app-network
    restart: unless-stopped

  etcd:
    container_name: milvus-etcd-dev
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - ./docker/volumes/milvus/etcd:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - app-network
    restart: unless-stopped

  minio:
    container_name: milvus-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - ./docker/volumes/milvus/minio:/minio_data
    command: minio server /minio_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - app-network
    restart: unless-stopped

  milvus:
    image: milvusdb/milvus:v2.5.6
    container_name: milvus
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MILVUS_LOG_LEVEL: error
    volumes:
      - ./docker/volumes/milvus/milvus:/var/lib/milvus
      - ./docker/volumes/milvus/logs:/var/lib/milvus/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 60s
      start_period: 120s
      timeout: 30s
      retries: 5
    ports:
      - "19530:19530"
      - "9091:9091"
    depends_on:
      - "etcd"
      - "minio"
    networks:
      - app-network
    restart: unless-stopped

  # 文档解析服务
  mineru-api:
    build:
      context: scripts/mineru-api
      dockerfile: Dockerfile
    image: mineru-api:latest
    container_name: mineru-api
    profiles:
      - all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    ports:
      - "5051:5051"
    networks:
      - app-network
    restart: unless-stopped
    command: python -m uvicorn app:app --host 0.0.0.0 --port 5051 --app-dir /app

  tianshu-backend:
    build:
      context: ./mineru-tianshu
      dockerfile: backend/Dockerfile
    image: tianshu-backend:latest
    container_name: tianshu-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./tianshu/models:/app/models:rw
      - ./tianshu/data/uploads:/app/uploads:rw
      - ./tianshu/data/output:/app/output:rw
      - ./tianshu/logs/backend:/app/logs:rw
      - ./tianshu/data/db:/app/data/db:rw
      - ./saves/data/graphragfile:/app/saves/data/graphragfile:rw
      - ./saves/data/copypath:/app/saves/data/copypath:rw
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - LOG_LEVEL=INFO
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-defaultkey}
      - WORKER_URL=http://tianshu-worker:8001
      - DATABASE_PATH=/app/data/db/mineru_tianshu.db
    networks:
      - app-network
    depends_on:
      tianshu-worker:
        condition: service_started


  tianshu-worker:
    build:
      context: ./mineru-tianshu
      dockerfile: backend/Dockerfile
    image: tianshu-worker:latest
    container_name: tianshu-worker
    restart: unless-stopped
    command: [ "python", "litserve_worker.py" ]
    ports:
      - "8001:8001"
    volumes:
      - ./tianshu/models:/app/models:ro
      - ./tianshu/data/uploads:/app/uploads:ro
      - ./tianshu/data/output:/app/output:rw
      - ./tianshu/logs/worker:/app/logs:rw
      - ./tianshu/data/db:/app/data/db:rw
      - ./saves/data/graphragfile:/app/saves/data/graphragfile:rw
      - ./saves/data/copypath:/app/saves/data/copypath:rw
    environment:
      - HOST=0.0.0.0
      - PORT=8001
      - LOG_LEVEL=INFO
      - DATABASE_PATH=/app/data/db/mineru_tianshu.db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-defaultkey}
      - HF_ENDPOINT=https://hf-mirror.com
    networks:
      - app-network

  graphrag-worker:
    build:
      context: .
      dockerfile: docker/graphrag.Dockerfile
    image: graphrag-worker:0.1.1
    container_name: graphrag-worker
    working_dir: /app
    volumes:
      - ./indexing:/app/indexing:rw  # 绑定索引数据目录
      - ./indexing_drill:/app/indexing_drill:rw  # 绑定索引数据目录
      - ./saves/data/graphragfile:/app/saves/data/graphragfile:rw
      - ./saves/data/copypath:/app/saves/data/copypath:rw
      - ./graphrag_api:/app/graphrag_api:rw
    ports:
      - "8111:8111"   # 暴露 FastAPI
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
